!function(){"use strict";function e(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function r(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function t(t){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?r(Object(a),!0).forEach((function(r){e(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function n(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function a(e,r){if(e){if("string"===typeof e)return n(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?n(e,r):void 0}}function o(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t=null==e?null:"undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,a,o=[],i=!0,u=!1;try{for(t=t.call(e);!(i=(n=t.next()).done)&&(o.push(n.value),!r||o.length!==r);i=!0);}catch(s){u=!0,a=s}finally{try{i||null==t.return||t.return()}finally{if(u)throw a}}return o}}(e,r)||a(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,r){if(e&&r)return!Array.isArray(r)&&console.error(r),r.reduce((function(e,r){return null===e||void 0===e?void 0:e[r]}),e)}function s(e,r){return Object.fromEntries(e.map((function(e,t){return[e,r(e,t)]})))}function c(e,r){return Object.fromEntries(e.map((function(e){return r(e)})))}function l(e){throw new Error("Should not reach this with value ".concat(e))}function f(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.reduce((function(e,r){return e.flatMap((function(e){return r.map((function(r){return[e,[r]].flat()}))}))}),[[]])}function p(e,r){var t="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=a(e))||r&&e&&"number"===typeof e.length){t&&(e=t);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,s=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return u=e.done,e},e:function(e){s=!0,i=e},f:function(){try{u||null==t.return||t.return()}finally{if(s)throw i}}}}function d(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function h(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,r,t){return r&&h(e.prototype,r),t&&h(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}m(NaN,{key:"TODO"}),b(1),b(0);function m(e,r){return{operation:"const",operands:[],value:e,info:r}}function b(e,r){return e>=Number.MAX_VALUE/100&&(e=1/0),e<=-Number.MAX_VALUE/100&&(e=-1/0),m(e,t({key:"_"},r))}function g(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return{operation:"add",operands:w(r)}}function y(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return{operation:"mul",operands:w(r)}}function w(e){return e.map((function(e){return"object"===typeof e?e:m(e)}))}function E(e){return"object"!==typeof e?m(e):e}function S(e,r,n){var a=new Set,o=new Map,i=new Map;function u(e){var s=o.get(e);if(s)return s;s=r(e);var c=i.get(s);return c||(a.has(s)?(console.error("Found cyclical dependency during formula mapping"),m(NaN)):(a.add(s),c=n(function(e){var r=e.operands.map(u);return k(r,e.operands)?e:t(t({},e),{},{operands:r})}(s),e),a.delete(s),o.set(e,c),i.set(s,c),c))}var s=e.map(u);return k(s,e)?e:s}function k(e,r){return void 0===e?void 0===r:void 0!==r&&(e.length===r.length&&e.every((function(e,t){return e===r[t]})))}var M={min:function(e){return Math.min.apply(Math,o(e))},max:function(e){return Math.max.apply(Math,o(e))},add:function(e){return e.reduce((function(e,r){return e+r}),0)},mul:function(e){return e.reduce((function(e,r){return e*r}),1)}},O=t(t({},M),{},{res:function(e){var r=i(e,1)[0];return r<0?1-r/2:r>=.75?1/(4*r+1):1-r},sum_frac:function(e){return e[0]/e.reduce((function(e,r){return e+r}))},threshold:function(e){var r=i(e,4),t=r[0],n=r[1],a=r[2],o=r[3];return t>=n?a:o}}),j=new Set(Object.keys(M));function x(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return!1};return e=P(e=A(e=T(e,r,t)))}function B(e,r){var t=new Set,n=new Set,a=new Map;!function(e,r,t){var n=new Set,a=new Set;e.forEach((function e(o){a.has(o)||(n.has(o)?console.error("Found cyclical dependency during formula traversal"):(n.add(o),r(o),o.operands.forEach(e),t(o),n.delete(o),a.add(o)))}))}(e,(function(e){}),(function(e){var o=e.operation;switch(o){case"read":if("number"!==e.type||e.accu&&"add"!==e.accu)throw new Error("Unsupported ".concat(o," node in precompute"));var i=r(e);t.add(i),a.set(e,i);break;case"add":case"min":case"max":case"mul":case"threshold":case"res":case"sum_frac":a.set(e,{ins:e.operands.map((function(e){return a.get(e)}))});break;case"const":if("number"!==typeof e.value)throw new Error("Found string constant while precomputing");var u=e.value;n.add(u),a.set(e,u);break;case"match":case"lookup":case"subscript":case"prio":case"small":case"data":throw new Error("Unsupported ".concat(o," node in precompute"));default:l(o)}}));var u=new Map,c=o(t),f=e.length,p=o(n),d=[];e.forEach((function(e,r){u.set(e,r),"const"===e.operation&&u.set(e.value,r)})),c.forEach((function(r,t){return u.set(r,t+e.length)}));var h=e.length+c.length;p.forEach((function(e){return u.has(e)||u.set(e,h++)})),a.forEach((function(e,r){"object"===typeof e?(u.has(r)||u.set(r,h++),d.push({out:u.get(r),ins:r.operands.map((function(e){return u.get(e)})),op:O[r.operation],buff:Array(r.operands.length).fill(0)})):u.set(r,u.get(e))}));var v=new Float64Array(h).fill(0);n.forEach((function(e){return v[u.get(e)]=e}));var m=e.map((function(e,r){var t=u.get(e);return t!==r?[t,r]:void 0})).filter((function(e){return e})),b=m.length?function(){m.forEach((function(e){var r=i(e,2),t=r[0],n=r[1];return v[n]=v[t]}))}:void 0;return[function(){return d.forEach((function(e){var r=e.out,t=e.ins,n=e.op,a=e.buff;t.forEach((function(e,r){return a[r]=v[e]})),v[r]=n(a)})),null===b||void 0===b||b(),v},s(c,(function(e,r){return f+r})),v]}function A(e){return S(e,(function(e){return e}),(function(e){var r=e;if(j.has(e.operation)){var n=e,a=n.operation,o=!1,i=n.operands.flatMap((function(e){return e.operation===a?(o=!0,e.operands):[e]}));r=o?t(t({},n),{},{operands:i}):n}return r}))}function P(e){function r(e){var r,t=new Map,n=p(e);try{for(n.s();!(r=n.n()).done;){var a,o=r.value;t.set(o,(null!==(a=t.get(o))&&void 0!==a?a:0)+1)}}catch(i){n.e(i)}finally{n.f()}return t}for(var n={common:{counts:new Map,formulas:new Set,operation:"add"}},a=function(){for(var a,u=void 0,s={operation:n.common.operation,operands:(a=n.common.counts,o(a).flatMap((function(e){var r=i(e,2),t=r[0],n=r[1];return Array(n).fill(t)})))},c=new Map,l=0,f=Object.keys(M);l<f.length;l++){var d=f[l];c.set(d,[])}if(e=S(e,(function(e){if(n.common.formulas.has(e)){var r=e,a=new Map(n.common.counts),o=r.operands.filter((function(e){var r=a.get(e);return!r||(a.set(e,r-1),!1)}));return o.length?(o.push(s),t(t({},r),{},{operands:o})):s}return e}),(function(e){if(!j.has(e.operation))return e;var t=e;if(u){if(u.operation===t.operation){var n,a=r(t.operands),o=new Map,s=u.counts,l=0,f=p(a.entries());try{for(f.s();!(n=f.n()).done;){var d,h=i(n.value,2),v=h[0],m=h[1],b=Math.min(m,null!==(d=s.get(v))&&void 0!==d?d:0);b?(o.set(v,b),l+=b):o.delete(v)}}catch(I){f.e(I)}finally{f.f()}l>1&&(u.counts=o,u.formulas.add(t))}}else{var g,y=c.get(t.operation),w=r(t.operands),E=p(y);try{for(E.s();!(g=E.n()).done;){var S,k=i(g.value,2),M=k[0],O=k[1],x=0,B=new Map,A=p(O.entries());try{for(A.s();!(S=A.n()).done;){var P,T=i(S.value,2),F=T[0],D=T[1],C=Math.min(D,null!==(P=w.get(F))&&void 0!==P?P:0);C&&(B.set(F,C),x+=C)}}catch(I){A.e(I)}finally{A.f()}if(x>1){u={counts:B,formulas:new Set([t,M]),operation:t.operation},c.clear();break}}}catch(I){E.e(I)}finally{E.f()}u||y.push([t,w])}return t})),!u)return"break";n.common=u};;){if("break"===a())break}return e}function T(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return!1},a={data:[],processed:new Map},s=new Map([[a,new Map]]);function c(e,r){var f,d=r.processed.get(e);if(d)return d;var h,v=e.operation;switch(v){case"const":return e;case"add":case"mul":case"max":case"min":var b=O[v],g=[],y=e.operands.filter((function(e){var t=c(e,r);return"const"!==t.operation||(g.push(t.value),!1)})).map((function(e){return c(e,r)})),w=b(g);if(isFinite(w)){if("mul"===v&&0===w){h=m(w);break}}else if("mul"!==v&&("max"!==v||w>0)&&("min"!==v||w<0)){h=m(w);break}w!==b([])&&y.push(m(w)),h=y.length<=1?null!==(f=y[0])&&void 0!==f?f:m(b([])):{operation:v,operands:y};break;case"res":case"sum_frac":var E=e.operands.map((function(e){return c(e,r)})),S=O[v];h=E.every((function(e){return"const"===e.operation}))?m(S(E.map((function(e){return e.value})))):t(t({},e),{},{operands:E});break;case"lookup":var k=c(e.operands[0],r);if("const"===k.operation){var M,j=null!==(M=e.table[k.value])&&void 0!==M?M:e.operands[1];if(j){h=c(j,r);break}}throw new Error("Unsupported ".concat(v," node while folding"));case"prio":var x=e.operands.find((function(e){var t=c(e,r);if("const"!==t.operation)throw new Error("Unsupported ".concat(v," node while folding"));return void 0!==t.value}));h=x?c(x,r):m(void 0);break;case"small":var B,A,P=void 0,T=p(e.operands);try{for(T.s();!(A=T.n()).done;){var F,D=c(A.value,r);if("const"!==D.operation)throw new Error("Unsupported ".concat(v," node while folding"));(void 0===(null===(F=P)||void 0===F?void 0:F.value)||void 0!==D.value&&D.value<P.value)&&(P=D)}}catch(X){T.e(X)}finally{T.f()}h=null!==(B=P)&&void 0!==B?B:m(void 0);break;case"match":var C=i(e.operands.map((function(e){return c(e,r)})),4),I=C[0],R=C[1],N=C[2],W=C[3];if("const"!==I.operation||"const"!==R.operation)throw new Error("Unsupported ".concat(v," node while folding"));h=I.value===R.value?N:W;break;case"threshold":var V=i(e.operands.map((function(e){return c(e,r)})),4),H=V[0],L=V[1],z=V[2],G=V[3];h="const"===H.operation&&"const"===L.operation?H.value>=L.value?z:G:t(t({},e),{},{operands:[H,L,z,G]});break;case"subscript":var U=i(e.operands.map((function(e){return c(e,r)})),1)[0];h="const"===U.operation?m(e.list[U.value]):t(t({},e),{},{operands:[U]});break;case"read":var q=r.data.map((function(r){return u(r,e.path)})).filter((function(e){return e}));if(0===q.length)if(n(e)){var K=e.accu;h=void 0===K||"small"===K?"string"===e.type?m(void 0):m(NaN):m(O[K]([]))}else h=e;else h=void 0===e.accu||1===q.length?c(q[q.length-1],r):c({operation:e.accu,operands:q},r);break;case"data":e.reset&&(r=a);var _=s.get(r),J=_.get(e.data);J||(J={data:[].concat(o(r.data),[e.data]),processed:new Map},s.set(J,new Map),_.set(e.data,J)),h=c(e.operands[0],J);break;default:l(v)}return r.processed.set(e,h),h}var f={data:[r],processed:new Map};return s.set(f,new Map),s.get(a).set(r,f),e.map((function(e){return c(e,f)}))}var F=["flower","plume","sands","goblet","circlet"],D=(["physical"].concat(["anemo","geo","electro","hydro","pyro","cryo"]),["Adventurer","ArchaicPetra","Berserker","BlizzardStrayer","BloodstainedChivalry","BraveHeart","CrimsonWitchOfFlames","DefendersWill","EchoesOfAnOffering","EmblemOfSeveredFate","Gambler","GladiatorsFinale","HeartOfDepth","HuskOfOpulentDreams","Instructor","Lavawalker","LuckyDog","MaidenBeloved","MartialArtist","NoblesseOblige","OceanHuedClam","PaleFlame","PrayersForDestiny","PrayersForIllumination","PrayersForWisdom","PrayersToSpringtime","ResolutionOfSojourner","RetracingBolide","Scholar","ShimenawasReminiscence","TenacityOfTheMillelith","TheExile","ThunderingFury","Thundersoother","TinyMiracle","TravelingDoctor","VermillionHereafter","ViridescentVenerer","WanderersTroupe"]);[].concat(["AmenomaKageuchi","AquilaFavonia","BlackcliffLongsword","CinnabarSpindle","CoolSteel","DarkIronSword","DullBlade","FavoniusSword","FesteringDesire","FilletBlade","FreedomSworn","HaranGeppakuFutsu","HarbingerOfDawn","IronSting","LionsRoar","MistsplitterReforged","PrimordialJadeCutter","PrototypeRancour","RoyalLongsword","SacrificialSword","SilverSword","SkyriderSword","SkywardBlade","SummitShaper","SwordOfDescension","TheAlleyFlash","TheBlackSword","TheFlute","TravelersHandySword"],["Akuoumaru","BlackcliffSlasher","BloodtaintedGreatsword","DebateClub","FavoniusGreatsword","FerrousShadow","KatsuragikiriNagamasa","LithicBlade","LuxuriousSeaLord","OldMercsPal","PrototypeArchaic","Rainslasher","RedhornStonethresher","RoyalGreatsword","SacrificialGreatsword","SerpentSpine","SkyriderGreatsword","SkywardPride","SnowTombedStarsilver","SongOfBrokenPines","TheBell","TheUnforged","WasterGreatsword","Whiteblind","WhiteIronGreatsword","WolfsGravestone"],["BeginnersProtector","BlackcliffPole","BlackTassel","CalamityQueller","CrescentPike","Deathmatch","DragonsBane","DragonspineSpear","EngulfingLightning","FavoniusLance","Halberd","IronPoint","KitainCrossSpear","LithicSpear","PrimordialJadeWingedSpear","PrototypeStarglitter","RoyalSpear","SkywardSpine","StaffOfHoma","TheCatch","VortexVanquisher","WavebreakersFin","WhiteTassel"],["AlleyHunter","AmosBow","AquaSimulacra","BlackcliffWarbow","CompoundBow","ElegyForTheEnd","FadingTwilight","FavoniusWarbow","Hamayumi","HuntersBow","Messenger","MitternachtsWaltz","MouunsMoon","PolarStar","Predator","PrototypeCrescent","RavenBow","RecurveBow","RoyalBow","Rust","SacrificialBow","SeasonedHuntersBow","SharpshootersOath","SkywardHarp","Slingshot","TheStringless","TheViridescentHunt","ThunderingPulse","WindblumeOde"],["ApprenticesNotes","BlackcliffAgate","DodocoTales","EmeraldOrb","EverlastingMoonglow","EyeOfPerception","FavoniusCodex","Frostbearer","HakushinRing","KagurasVerity","LostPrayerToTheSacredWinds","MagicGuide","MappaMare","MemoryOfDust","OathswornEye","OtherworldlyStory","PocketGrimoire","PrototypeAmber","RoyalGrimoire","SacrificialFragments","SkywardAtlas","SolarPearl","TheWidsith","ThrillingTalesOfDragonSlayers","TwinNephrite","WineAndSong"]);function C(e,r){return{base:e.base,values:s(F,(function(t){var n=r[t];switch(n.kind){case"id":return e.values[t].filter((function(e){return n.ids.has(e.id)}));case"exclude":return e.values[t].filter((function(e){return!n.sets.has(e.set)}));case"required":return e.values[t].filter((function(e){return n.sets.has(e.set)}))}}))}}function I(e){return F.reduce((function(r,t){return r*e.values[t].length}),1)}s(F,(function(e){return{kind:"exclude",sets:new Set}}));var R=function(){function e(r,n){var a=this,o=r.arts,i=r.optimizationTarget,u=r.filters,s=r.plotBase,c=r.maxBuilds;d(this,e),this.builds=[],this.buildValues=void 0,this.plotData=void 0,this.plotBase=void 0,this.threshold=-1/0,this.maxBuilds=void 0,this.min=void 0,this.arts=void 0,this.nodes=void 0,this.callback=void 0,this.interimReport=function(e){a.refresh(!1),a.callback(t({command:"interim",buildValues:a.buildValues},e)),a.buildValues=void 0,e.tested=0,e.failed=0,e.skipped=0},this.arts=o,this.min=u.map((function(e){return e.min})),this.maxBuilds=c,this.callback=n,this.nodes=u.map((function(e){return e.value})),this.nodes.push(i),s&&(this.plotData={},this.plotBase=s,this.nodes.push(s))}return v(e,[{key:"compute",value:function(e,r){this.threshold<e&&(this.threshold=e);var t=r.optimizationTarget,n=r.constraints,a=r.filter,u=r.artSetExclusion,s=r.depth,c=this.interimReport,l=this,f=C(this.arts,a),d=I(f);if(!(r.cache&&r.cachedCompute.maxEst[r.cachedCompute.maxEst.length-1]<this.threshold)){var h=[].concat(o(n.map((function(e){return e.value}))),[t]);void 0!==this.plotBase&&h.push(this.plotBase),h=x(h,{},(function(e){return!1}));for(var v=n.map((function(e){return e.min})),m=B(h,(function(e){return e.path[1]})),b=i(m,3),g=b[0],y=b[1],w=b[2],E=Object.values(f.values).sort((function(e,r){return e.length-r.length})).map((function(e){return e.map((function(e){return{id:e.id,set:e.set,values:Object.entries(e.values).map((function(e){var r=i(e,2),t=r[0],n=r[1];return{key:y[t],value:n,cache:0}})).filter((function(e){var r=e.key,t=e.value;return void 0!==r&&0!==t}))}}))})),S=Array(E.length).fill(""),k={tested:0,failed:0,skipped:d-I(f)},M=-1/0,O=0,j=Object.entries(f.base);O<j.length;O++){var A=i(j[O],2),P=A[0],T=A[1],F=y[P];void 0!==F&&(w[F]=T)}if(N(E.length-1,{}),r.cache){var D=r.cachedCompute,R=D.maxEst[D.maxEst.length-1];console.log("enumerated",{count:I(f),depth:s},this.threshold,{gap:R-M},{nodes:h,preArts:f},D)}return this.interimReport(k),this.threshold}function N(e,r){if(e<0){var t=g();M=Math.max(t[n.length],M);var a=Object.entries(u).every((function(e){var t=i(e,2),n=t[0];return!t[1].includes(r[n])}));if(a&&void 0!==u.uniqueKey){var s=Object.values(r).reduce((function(e,r){return e+r%2}),0);a=!u.uniqueKey.includes(s)}if(a&&v.every((function(e,r){return e<=t[r]}))){var f,d=t[v.length],h=l.builds,m=l.plotData;if(d>=l.threshold&&(f={value:d,artifactIds:o(S)},h.push(f)),m){var b=t[v.length+1];(!m[b]||m[b].value<d)&&(f||(f={value:d,artifactIds:o(S)}),f.plot=b,m[b]=f)}}else k.failed+=1}else E[e].forEach((function(t){var n,a,o,i,u,s;S[e]=t.id;var c,l=p(t.values);try{for(l.s();!(c=l.n()).done;){var f=c.value,d=f.key,h=f.value;f.cache=w[d],w[d]+=h}}catch(E){l.e(E)}finally{l.f()}r[null!==(n=t.set)&&void 0!==n?n:""]=1+(null!==(a=r[null!==(o=t.set)&&void 0!==o?o:""])&&void 0!==a?a:0),N(e-1,r),r[null!==(i=t.set)&&void 0!==i?i:""]-=1,0===r[null!==(u=t.set)&&void 0!==u?u:""]&&delete r[null!==(s=t.set)&&void 0!==s?s:""];var v,m=p(t.values);try{for(m.s();!(v=m.n()).done;){var b=v.value,g=b.key,y=b.cache;w[g]=y}}catch(E){m.e(E)}finally{m.f()}})),0===e&&(k.tested+=E[0].length,k.tested>8192&&c(k))}this.interimReport({tested:0,failed:0,skipped:d})}},{key:"refresh",value:function(e){var r,t,n=this.maxBuilds;Object.keys(null!==(r=this.plotData)&&void 0!==r?r:{}).length>=1e5&&(this.plotData=function(e){for(var r=.01,t=new Set(e.flatMap((function(e){return Object.values(e).map((function(e){return Math.round(e.plot/r)}))})));t.size>1500;)r*=2,t=new Set(o(t).map((function(e){return Math.round(e/2)})));var n,a={},i=p(e);try{for(i.s();!(n=i.n()).done;)for(var u=n.value,s=0,c=Object.values(u);s<c.length;s++){var l=c[s],f=Math.round(l.plot/r)*r;(!a[f]||a[f].value<l.value)&&(a[f]=l)}}catch(d){i.e(d)}finally{i.f()}return a}([this.plotData])),this.builds=this.builds.sort((function(e,r){return r.value-e.value})).slice(0,n),this.buildValues=this.builds.map((function(e){return e.value})),this.threshold=Math.max(this.threshold,null!==(t=this.buildValues[n-1])&&void 0!==t?t:-1/0)}}]),e}();function N(e){if(1===e.length)return e[0];var r=(e=e.flatMap((function(e){return"add"===e.operation?e.operands:e}))).reduce((function(e,r){return"const"===r.operation?e+r.value:e}),0);return 0===(e=e.filter((function(e){return"const"!==e.operation}))).length?m(r):0===r?g.apply(void 0,o(e)):g.apply(void 0,o(e).concat([m(r)]))}function W(e){if(1===e.length)return e[0];var r=(e=e.flatMap((function(e){return"mul"===e.operation?e.operands:e}))).reduce((function(e,r){return"const"===r.operation?e*r.value:e}),1);return 0===(e=e.filter((function(e){return"const"!==e.operation}))).length?m(r):1===r?y.apply(void 0,o(e)):y.apply(void 0,o(e).concat([m(r)]))}function V(e,r){return S([e],(function(e){return e}),(function(e){switch(e.operation){case"mul":var t=e.operands.map((function(e){return"add"===e.operation?e.operands:[e]})).map((function(e,t){var n=e.map((function(e){return r(e)||"mul"===e.operation&&e.operands.some(r)})),a=e.filter((function(e,r){return n[r]})),i=e.filter((function(e,r){return!n[r]}));return 0===i.length?a:[].concat(o(a),[N(i)])}));return N(f.apply(void 0,o(t)).map((function(e){return W(e)})));case"add":return N(e.operands.flatMap((function(e){return"add"===e.operation?e.operands:e})));default:return e}}))[0]}function H(e){return L(e)<=5}function L(e){if("add"===e.operation)return Math.min.apply(Math,o(e.operands.map((function(e){return L(e)}))));if("mul"===e.operation)return e.operands.map((function(e){return L(e)})).reduce((function(e,r){return e+r}));if("threshold"===e.operation){var r=e.operands[0];if("read"===r.operation&&D.includes(r.path[1]))return e.operands[1].value}return 0}function z(e,r){var t=r.i,n=r.j,a=e[t][n];return e.map((function(r,o){return r.map((function(r,i){return o===t&&i===n?1/a:o===t?e[t][i]/a:i===n?-e[o][n]/a:r-e[t][i]*e[o][n]/a}))}))}function G(e){for(var r=e.length,t=e[0].length,n={i:-1,j:-1,cmp:1/0},a=0;a<t-1;a++)if(!(e[r-1][a]>=0)){for(var o=0;o<r-1;o++)if(e[o][a]>1e-5){var i=e[o][t-1]/e[o][a];i<n.cmp&&(n={i:o,j:a,cmp:i})}if(n.i<0)throw Error("UNBOUNDED FEASIBLE")}if(n.i<0)throw Error("NO PIVOTS (done)");return{i:n.i,j:n.j}}function U(e){for(var r=e.length,t=e[0].length,n={i:-1,j:-1,cmp:1/0},a=0;a<r-1;a++)if(!(e[a][t-1]>=0)){for(var o=0;o<t-1;o++)if(e[a][o]<-1e-5){var i=e[a][t-1]/e[a][o];i<n.cmp&&(n={i:a,j:o,cmp:i})}if(n.i<0)throw Error("INFEASIBLE");return{i:n.i,j:n.j}}throw Error("NO PIVOTS (done)")}function q(e,r,t){var n=i(B([e],(function(e){return e.path[1]})),3),a=n[0],o=n[1],u=n[2];Z(r,o,u);var s=a()[0];return Z(t,o,u),[s,a()[0]]}function K(e,r,t){var n=function e(r){switch(r.operation){case"add":return g.apply(void 0,o(r.operands.map((function(r){return e(r)}))));case"const":return m(-r.value);case"threshold":var t=i(r.operands,4),n=t[0],a=t[1],u=t[2],s=t[3];if("const"===u.operation&&"const"===s.operation&&u.value<=s.value)return c=n,l=a,f=-u.value,p=s.value,{operation:"threshold",operands:[E(c),E(l),E(f),E(p)],info:d};throw console.log(r),Error("(res neg slope): threshold. Something went wrong.");default:throw console.log(r),Error("(res neg slope) Havent written logic to handle this")}var c,l,f,p,d}(e.operands[0]),a=i(q(n,r,t),2),u=a[0],s=a[1],c=O.res,l=[c([-u]),c([-s])],f=l[0],p=l[1];return s>0&&u>-1.75?g(1,y(.5,n)):g((s*f-u*p)/(s-u),y((f-p)/(s-u),n))}function _(r,t,n){var a=V(function e(r){switch(r.operation){case"const":case"read":return r;case"add":return N(r.operands.map((function(r){return e(r)})));case"mul":return W(r.operands.map((function(r){return e(r)})));case"threshold":var a=i(r.operands,4),o=a[0],u=a[1],s=a[2],c=a[3];if("read"===o.operation&&"const"===u.operation&&"const"===c.operation&&"const"===s.operation){var l=o.path[1];if(t[l]>=u.value)return m(s.value);if(n[l]<u.value)return m(c.value);if(s.value<c.value)throw console.log(r),Error("Not Implemented (threshold must be increasing)");var f=(s.value-c.value)/u.value;return g(c.value,y(f,o))}throw console.log(r),Error("Not Implemented (threshold must branch between constants)");case"res":var p=K(r,t,n);return e(p=V(p,(function(e){return"const"!==e.operation})));case"min":var d=i(r.operands,2),h=d[0],v=d[1];if("const"!==v.operation){var b=[v,h];h=b[0],v=b[1]}return e(h);case"max":var w=i(r.operands,2),E=w[0],S=w[1];if("const"!==S.operation){var k=[S,E];E=k[0],S=k[1]}if("const"===v.operation){var M=v.value,O=i(q(E,t,n),2),j=O[0],x=O[1];if(j>M)return E;if(M>x)return m(M);var B=M-j;return g(y((x-M)/(x-j),e(E)),B)}throw console.log(r),Error("Not Implemented (max)");case"sum_frac":var A=i(r.operands,2),P=A[0],T=A[1];if("const"!==T.operation)throw Error("Not Implemented (non-constant sum_frac denominator)");var F=i(q(P,t,n),2),D=F[0],C=F[1],I=T.value,R=Math.sqrt((D+I)*(C+I))-I,H=(I+R)*(I+R);return e(g(R*R/H,y(I/H,P)));default:throw console.log(r),Error("Not Implemented")}}(r),(function(e){return"const"!==e.operation}));if("const"===a.operation)return{w:{},c:a.value,err:0};function u(r){if("read"===r.operation)return{w:e({},r.path[1],1),c:0,err:0};if("const"===r.operation)return{w:{},c:r.value,err:0};if("mul"!==r.operation)throw console.log(r),Error("toLUB takes only mul nodes.");var a=1,i=r.operands.reduce((function(e,r){return"read"===r.operation&&e.push(r.path[1]),"const"===r.operation&&(a*=r.value),e}),[]),u=function(e){if(0===e.length)return{w:[],c:0,err:0};var r=e.length,t=e.map((function(e){return e.upper})),n=t.reduce((function(e,r){return e*r}),1);e=e.map((function(e){return{lower:e.lower/e.upper,upper:1}}));var a,i=f.apply(void 0,o(e.map((function(e){return[e.lower,e.upper]})))).flatMap((function(e){var r=e.reduce((function(e,r){return e*r}),1);return[[].concat(o(e.map((function(e){return-e}))),[1,0,-r]),[].concat(o(e),[-1,-1,r])]})),u=[].concat(o(e.map((function(e){return 0}))),[0,1]);try{a=function(e,r){var t=r.length+1,n=r[0].length,a=Array(t).fill(0).map((function(e){return Array(n).fill(0)}));r.forEach((function(e,r){return e.forEach((function(e,t){return a[r][t]=e}))})),e.forEach((function(e,r){return a[t-1][r]=e}));for(var o=[];a.some((function(e,r){return r<t-1&&e[n-1]<0}));){var i=U(a);o.push(i),a=z(a,i)}for(;a[t-1].some((function(e,r){return r<n-1&&e<0}));){var u=G(a);o.push(u),a=z(a,u)}return e.map((function(e,r){return function(e,r,t){var n=1;r.forEach((function(e){var r=e.i,a=e.j;1===n&&a===t?(t=r,n=0):0===n&&r===t&&(t=a,n=1)}));var a=e[0].length;return 0===n?e[t][a-1]:0}(a,o,r)}))}(u,i)}catch(s){throw console.log("ERROR on bounds",e),console.log("Possibly numerical instability issue."),s}return{w:a.slice(0,r).map((function(e,r){return e*n/t[r]})),c:-n*a[r],err:n*a[r+1]}}(i.map((function(e){return{lower:t[e],upper:n[e]}}))),s=u.w,c=u.c,l=u.err;return{w:s.reduce((function(e,r,t){var n;return e[i[t]]=r*a+(null!==(n=e[i[t]])&&void 0!==n?n:0),e}),{}),c:c*a,err:l*a+0}}return"add"===a.operation?a.operands.map((function(e){return u(e)})):u(a)}function J(e,r){return X([r],[e.base])[0][0]+r.c+Object.entries(e.values).reduce((function(e,t){var n=i(t,2),a=(n[0],n[1]),u=X([r],a.map((function(e){return e.values}))).map((function(e){return e[0]}));return e+Math.max.apply(Math,o(u))}),0)}function X(e,r){return r.map((function(r){return e.map((function(e){var t=e.w;return Object.entries(t).reduce((function(e,t){var n,a=i(t,2),o=a[0];return e+a[1]*(null!==(n=r[o])&&void 0!==n?n:0)}),0)}))}))}function Q(e){var r={},t={},n=new Set;return e.forEach((function(e){for(var a in e.values){var o,i;r[a]=Math.min(e.values[a],null!==(o=r[a])&&void 0!==o?o:1/0),t[a]=Math.max(e.values[a],null!==(i=t[a])&&void 0!==i?i:-1/0)}e.set&&(t[e.set]=1,r[e.set]=0),n.add(e.set)})),1===n.size&&e[0].set&&(r[e[0].set]=1),{statsMin:r,statsMax:t}}function $(e,r,t){var n=Object.keys(r).filter((function(e){return r[e]===t[e]}));return x(S(e,(function(e){return e}),(function(e){if("read"===e.operation&&n.includes(e.path[1]))return m(r[e.path[1]]);if("threshold"===e.operation){var a=i(e.operands,4),o=a[0],u=a[1];a[2],a[3];if("read"===o.operation&&"const"===u.operation){if(r[o.path[1]]>=u.value)return e.operands[2];if(t[o.path[1]]<u.value)return e.operands[3]}}return e})),{})}function Y(e){var r=e.f,t=e.a,n=e.cachedCompute;if(void 0!==r){var a=n.lower,o=n.upper,u=r.map((function(e){return function(e,r,t){var n=t.statsMin,a=t.statsMax;if("const"===e.operation)return{maxEst:e.value,lin:_(e,n,a)};if("read"===e.operation)return{maxEst:a[e.path[1]],lin:_(e,n,a)};var o=V(e,(function(e){switch(e.operation){case"read":case"max":case"min":case"sum_frac":case"threshold":return!0;default:return!1}})).operands.filter(H).flatMap((function(e){return _(e,n,a)})).reduce((function(e,r){return Object.entries(r.w).forEach((function(r){var t,n=i(r,2),a=n[0],o=n[1];return e.w[a]=o+(null!==(t=e.w[a])&&void 0!==t?t:0)})),{w:e.w,c:e.c+r.c,err:e.err+r.err}}),{w:{},c:0,err:0});return{maxEst:J(r,o),lin:o}}(e,t,{statsMin:a,statsMax:o})}));return{maxEst:u.map((function(e){return e.maxEst})),lin:u.map((function(e){return e.lin})),lower:a,upper:o}}var s=n.lin,c=n.lower,l=n.upper;return{maxEst:s.map((function(e){return J(t,e)})),lin:s,lower:c,upper:l}}function Z(e,r,t){Object.entries(e).filter((function(e){var t=i(e,1)[0];return void 0!==r[t]})).forEach((function(e){var n=i(e,2),a=n[0],o=n[1];return t[r[a]]=o}))}var ee,re,te,ne=function(){function e(r,t){var n=r.arts,a=r.optimizationTarget,o=r.filters,u=r.artSetExclusion;d(this,e),this.min=void 0,this.arts=void 0,this.nodes=void 0,this.artSet=void 0,this.subproblems=[],this.callback=void 0,this.arts=n,this.min=o.map((function(e){return e.min})),this.nodes=o.map((function(e){return e.value})),this.callback=t,this.min.push(-1/0),this.nodes.push(a),this.artSet=c(Object.entries(u),(function(e){var r=i(e,2),t=r[0],n=r[1];return"rainbow"===t?["uniqueKey",n.map((function(e){return e+1}))]:[t,n.flatMap((function(e){return 2===e?[2,3]:[4,5]}))]}))}return v(e,[{key:"addSubProblem",value:function(e){var r=I(C(this.arts,e.filter));if(0!==r){var t=e.cache?e.cachedCompute.maxEst[e.cachedCompute.maxEst.length-1]:0;this.subproblems.push({count:r,heur:t,subproblem:e})}}},{key:"split",value:function(e){var r=this,t=e.threshold,n=e.minCount,a=e.maxIter,o=e.subproblem;t>this.min[this.min.length-1]&&(this.min[this.min.length-1]=t),o&&this.addSubProblem(o);for(var i=this.subproblems.reduce((function(e,r){return e+r.count}),0),u=0;u<a&&this.subproblems.length;){u+=1;var s=this.subproblems.pop(),c=s.count,l=s.subproblem;if(c<=n){var f=this.subproblems.reduce((function(e,r){return e+r.count}),0)+c;return this.callback({command:"interim",tested:0,failed:0,skipped:i-f,buildValues:void 0}),[l]}this.splitBNB(this.min[this.min.length-1],l).forEach((function(e){return r.addSubProblem(e)}))}var p=this.subproblems.reduce((function(e,r){return e+r.count}),0);return this.callback({command:"interim",tested:0,failed:0,skipped:i-p,buildValues:void 0}),[]}},{key:"popOne",value:function(){if(0!==this.subproblems.length){for(var e={i:-1,heur:-1/0},r=1;r<this.subproblems.length;r++){var t=this.subproblems[r],n=t.heur;t.subproblem;n>e.heur&&(e={i:r,heur:n})}if(!(e.i<0))return this.subproblems.splice(e.i,1)[0].subproblem}}},{key:"splitWork",value:function(e){var r=this,t=e.threshold,n=e.numSplits,a=e.subproblem;t>this.min[this.min.length-1]&&(this.min[this.min.length-1]=t),a&&this.addSubProblem(a);var o=this.subproblems.reduce((function(e,r){return e+r.count}),0);for(console.log("splitWork",this.min[this.min.length-1],{todo:this.subproblems.length,buildsleft:this.subproblems.reduce((function(e,r){return e+r.count}),0)});this.subproblems.length>0&&this.subproblems.length<=n;){var i=this.subproblems.shift().subproblem;this.splitBNB(this.min[this.min.length-1],i).forEach((function(e){return r.addSubProblem(e)}))}var u=this.subproblems.reduce((function(e,r){return e+r.count}),0);return this.callback({command:"interim",tested:0,failed:0,skipped:o-u,buildValues:void 0}),console.log("exit splitWork. Filters pre-exit",this.subproblems),this.subproblems.splice(0,n).map((function(e){return e.subproblem}))}},{key:"splitBNB",value:function(e,r){var n=C(this.arts,r.filter);if(!1===r.cache){var a=function(e){var r=t({},e.base),n=t({},e.base);return Object.entries(e.values).forEach((function(e){var t=i(e,2),a=(t[0],Q(t[1])),o=a.statsMin,u=a.statsMax;Object.keys(o).forEach((function(e){var t,a;r[e]=o[e]+(null!==(t=r[e])&&void 0!==t?t:0),n[e]=u[e]+(null!==(a=n[e])&&void 0!==a?a:0)}))})),{statsMin:r,statsMax:n}}(n),u=a.statsMin,l=a.statsMax,p=ae(r,u,l);if(void 0===p)return[];var d=Y({f:[].concat(o(p.constraints.map((function(e){return e.value}))),[p.optimizationTarget]),a:n,cachedCompute:{lower:u,upper:l}});if(p.constraints.some((function(e,r){var t=e.min;return d.maxEst[r]<t})))return[];if(d.maxEst[d.maxEst.length-1]<e)return[];r=t(t({},p),{},{cache:!0,cachedCompute:d})}var h=r.cachedCompute;if(h.maxEst[h.maxEst.length-1]<e)return[];Object.values(n.values).reduce((function(e,r){return e*r.length}),1);var v=function(e,r,t){var n=t.constraints,a=t.cachedCompute.lin,u=(t.artSetExclusion,X(a,[e.base])[0]),s=X(a,[e.base])[0];Object.entries(e.values).forEach((function(e){var r=i(e,2),t=(r[0],r[1]),n=X(a,t.map((function(e){return e.values})));u.forEach((function(e,r){s[r]+=Math.max.apply(Math,o(n.map((function(e){return e[r]})))),u[r]+=Math.min.apply(Math,o(n.map((function(e){return e[r]}))))}))}));var c=[].concat(o(n.map((function(e){return e.min}))),[r]).map((function(e,r){return(e-u[r])/(s[r]-u[r])})).map((function(e){return e<.5?-1:e}));c[c.length-1]=Math.max(c[c.length-1],0);var l=c.reduce((function(e,r,t){return r>c[e]?t:e}),0),f=a[l],p=Object.keys(f.w),d={k:"",heur:-1};if(p.forEach((function(r){var t=Object.entries(e.values).reduce((function(e,t){var n=i(t,2),a=(n[0],n[1].map((function(e){return e.values[r]}))),u=Math.min.apply(Math,o(a)),s=Math.max.apply(Math,o(a));if(u===s)return e;var c=(u+s)/2,l=Math.max.apply(Math,o(a.filter((function(e){return e<=c})))),f=Math.min.apply(Math,o(a.filter((function(e){return e>c}))));return e+Math.min(s-l,f-u)}),0),n=f.w[r]*t;n>d.heur&&(d={k:r,heur:n})})),""===d.k)throw console.log(t,ae(t,t.cachedCompute.lower,t.cachedCompute.upper,!0)),console.log("===================== SHATTER BROKE ====================",a,e),Error("Shatter broke...");return d}(n,e,r),m=v.k,b=Object.fromEntries(Object.entries(n.values).map((function(e){var r=i(e,2),t=r[0],n=r[1].map((function(e){return e.values[m]}));return[t,(Math.min.apply(Math,o(n))+Math.max.apply(Math,o(n)))/2]}))),g=Object.fromEntries(Object.entries(n.values).map((function(e){var r=i(e,2),n=r[0],a=r[1],o=a.filter((function(e){return e.values[m]<b[n]})),u=a.filter((function(e){return!(e.values[m]<b[n])}));return[n,[t({arts:u},Q(u)),t({arts:o},Q(o))]]}))),y=[];return f([0,1],[0,1],[0,1],[0,1],[0,1]).forEach((function(a){var u=i(a,5),l=u[0],f=u[1],p=u[2],d=u[3],v=u[4],m={flower:g.flower[l],plume:g.plume[f],sands:g.sands[p],goblet:g.goblet[d],circlet:g.circlet[v]},b={base:t({},n.base),values:c(Object.entries(m),(function(e){var r=i(e,2);return[r[0],r[1].arts]}))},w=Object.values(b.values).reduce((function(e,r){return e*r.length}),1);if(0!==w){var E=t({},n.base),S=t({},n.base);Object.entries(m).forEach((function(e){var r=i(e,2),t=(r[0],r[1]),n=t.statsMin,a=t.statsMax;Object.entries(n).forEach((function(e){var r,t=i(e,2),n=t[0],a=t[1];return E[n]=a+(null!==(r=E[n])&&void 0!==r?r:0)})),Object.entries(a).forEach((function(e){var r,t=i(e,2),n=t[0],a=t[1];return S[n]=a+(null!==(r=S[n])&&void 0!==r?r:0)}))}));var k=ae(r,E,S);if(void 0!==k){var M=Y({a:b,cachedCompute:h}).maxEst;if(!k.constraints.some((function(e,r){var t=e.min;return M[r]<t}))&&!(M[M.length-1]<e)){var O=[].concat(o(k.constraints.map((function(e){return e.value}))),[k.optimizationTarget]),j=Y({a:b,f:O,cachedCompute:{lower:E,upper:S}});if(!k.constraints.some((function(e,r){var t=e.min;return j.maxEst[r]<t}))&&!(j.maxEst[j.maxEst.length-1]<e)){var x=s(F,(function(e){return{kind:"id",ids:new Set(b.values[e].map((function(e){return e.id})))}}));y.push({numBuilds:w,heur:j.maxEst[j.maxEst.length-1],subproblem:t(t({},k),{},{filter:x,cache:!0,cachedCompute:j,depth:k.depth+1})})}}}}})),y.sort((function(e,r){return r.numBuilds-e.numBuilds})),y.map((function(e){return e.subproblem}))}}]),e}();function ae(e,r,t){var n=e.optimizationTarget,a=e.constraints,u=e.artSetExclusion,s=e.filter,c=e.depth,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],f=[].concat(o(a.map((function(e){return e.value}))),[n]),p=a.map((function(e){return e.min})),d=B(f=$(f,r,t),(function(e){return e.path[1]})),h=i(d,3),v=h[0],m=h[1],b=h[2];Z(r,m,b);var g=v(),y=f.pop(),w=p.map((function(e,r){return e>g[r]})),E=f.map((function(e,r){return{value:e,min:p[r]}})).filter((function(e,r){return w[r]}));l&&console.log("reduceSubP",{statsMin:r,subnodes:f,submin:p,result:g,active:w});for(var S={},k=function(){var e=i(O[M],2),n=e[0],a=e[1];if("uniqueKey"===n)return S[n]=a,"continue";var o=a.filter((function(e){return r[n]<=e&&e<=t[n]}));if(o.includes(r[n])&&o.includes(t[n]))return{v:void 0};o.length>0&&(S[n]=o)},M=0,O=Object.entries(u);M<O.length;M++){var j=k();if("continue"!==j&&"object"===typeof j)return j.v}return{cache:!1,optimizationTarget:y,constraints:E,artSetExclusion:S,filter:s,depth:c}}onmessage=function(e){var r,n=e.data,a=n.command;switch(a){case"setup":ee=n.id;var o=function(e){return postMessage(t({id:ee},e))};re=new ne(n,o),te=new R(n,o),r={command:"iterate"};break;case"split":r={command:"split",subproblems:re.split(n),ready:0===re.subproblems.length};break;case"splitwork":r={command:"split",subproblems:re.splitWork(n),ready:0===re.subproblems.length};break;case"iterate":var i=n.threshold,u=n.subproblem;te.compute(i,u),r={command:"iterate"};break;case"finalize":te.refresh(!0);var s=te;r={command:"finalize",builds:s.builds,plotData:s.plotData};break;case"share":r={command:"share",subproblem:re.popOne(),sender:n.sender};break;default:l(a)}postMessage(t({id:ee},r))}}();
//# sourceMappingURL=BackgroundWorker.f36f17cc.worker.js.map